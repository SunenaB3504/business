<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Studies | Search All Chapters</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <style>
        .search-result-block { background: #f9fafb; border-radius: 0.5rem; margin-bottom: 1rem; padding: 1rem; box-shadow: 0 2px 8px #e0e7ef; }
        .search-highlight { background: #fef08a; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <header class="bg-blue-900 text-white py-6 px-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div>
                <h1 class="text-3xl font-bold mb-1">Business Studies</h1>
                <p class="text-lg">Search All Chapters</p>
            </div>
            <nav class="mt-4 md:mt-0 flex flex-wrap gap-6">
                <a href="index.html" class="text-white font-semibold hover:underline focus:outline-none">Home</a>
            </nav>
        </div>
    </header>
    <main class="p-8 max-w-3xl mx-auto bg-white shadow-lg mt-8 rounded-lg">
        <section class="mb-10">
            <h2 class="text-2xl font-bold mb-4">Search Across All Chapters</h2>
            <div class="mb-4 flex gap-2">
                <input id="searchInput" type="text" class="border rounded px-3 py-2 w-full" placeholder="Type your question or keyword here..." style="color: black; background: #f9fafb;" />
                <button id="audioInputBtn" class="px-3 py-2 bg-yellow-500 text-blue-900 rounded hover:bg-yellow-600" title="Ask by voice">ðŸŽ¤</button>
                <button id="searchBtn" class="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700">Search</button>
            </div>
            <div id="searchStatus" class="text-gray-600 text-sm mb-2"></div>
            <div id="searchResults" class="text-gray-900 text-base"></div>
        </section>
    </main>
    <footer class="bg-blue-900 text-white text-center py-4 mt-8 rounded-b-lg">
        &copy; 2025 GENZ Study Business | For Neil's Educational Needs
    </footer>
    <script>
    // List of all chapter JSON files
    const chapterFiles = [
        'chapter1.json','chapter2.json','chapter3.json','chapter4.json','chapter5.json','chapter6.json','chapter7.json','chapter8.json','chapter9.json','chapter10.json','chapter11.json'
    ];
    const searchInput = document.getElementById('searchInput');
    const audioInputBtn = document.getElementById('audioInputBtn');
    const searchBtn = document.getElementById('searchBtn');
    const searchResults = document.getElementById('searchResults');
    const searchStatus = document.getElementById('searchStatus');
    let recognition = null;

    // Voice search
    audioInputBtn.onclick = function() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('Speech recognition not supported in this browser.');
            return;
        }
        if (recognition) {
            recognition.stop();
            recognition = null;
        }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        recognition.lang = 'en-IN';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript;
            searchInput.value = transcript;
            performSearch(transcript);
        };
        recognition.onerror = function(event) {
            searchStatus.textContent = 'Audio input error: ' + event.error;
        };
        recognition.onend = function() {
            recognition = null;
        };
        recognition.start();
        searchStatus.textContent = 'Listening...';
    };

    // Search on button click or Enter
    searchBtn.onclick = function() { performSearch(searchInput.value.trim()); };
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') performSearch(searchInput.value.trim());
    });

    // Main search logic
    function performSearch(query) {
        if (!query) {
            searchStatus.textContent = 'Please enter a search term.';
            searchResults.innerHTML = '';
            return;
        }
        searchStatus.textContent = 'Searching all chapters...';
        searchResults.innerHTML = '';
        let foundResults = [];
        let filesLoaded = 0;
        chapterFiles.forEach(filename => {
            fetch(filename)
                .then(res => res.json())
                .then(data => {
                    const results = findInChapter(data, filename, query);
                    if (results.length) foundResults = foundResults.concat(results);
                })
                .catch(() => {
                    // Ignore missing files
                })
                .finally(() => {
                    filesLoaded++;
                    if (filesLoaded === chapterFiles.length) {
                        if (foundResults.length) {
                            const topResults = foundResults.slice(0, 3);
                            searchStatus.textContent = `Showing top ${topResults.length} of ${foundResults.length} result(s).`;
                            searchResults.innerHTML = topResults.join('<hr class="my-4">');
                        } else {
                            searchStatus.textContent = 'No results found.';
                            searchResults.innerHTML = '';
                        }
                    }
                });
        });
    }

    // Helper: Search all sections in a chapter JSON
    function findInChapter(data, filename, query) {
        query = query.toLowerCase();
        let results = [];
        const chapters = Array.isArray(data.chapters) ? data.chapters : Object.values(data);
        chapters.forEach(chapter => {
            const chapterTitle = chapter.title || chapter.unitName || filename.replace('.json','');
            if (chapter.mindmap) {
                chapter.mindmap.forEach(node => {
                    if (node.definition && node.definition.toLowerCase().includes(query)) {
                        results.push(renderResult('Definition', chapterTitle, node.definition, filename, query));
                    }
                });
            }
        });
        return results;
    }

    // Helper: Render a result block
    function renderResult(section, chapterTitle, text, filename, query) {
        const re = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        const highlighted = text.replace(re, '<span class="search-highlight">$1</span>');
        return `<div class="search-result-block">
            <div class="text-xs text-gray-500 mb-1">${section} | <b>${chapterTitle}</b> (${filename})</div>
            <div>${highlighted}</div>
        </div>`;
    }
    </script>
</body>
</html>
